<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Quiz Reviewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">

    <style>
        body {
            background-color: #f4f7f9;
        }

        .quiz-container {
            max-width: 900px;
            margin: 40px auto;
        }

        .question-card {
            border-left: 5px solid #007bff;
            margin-bottom: 30px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
            background-color: #ffffff;
            border-radius: 8px;
        }

        .metadata-card {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .status-passed {
            background-color: #198754;
            color: white;
        }

        .status-warnings {
            background-color: #ffc107;
            color: #212529;
        }

        .correct-option {
            background-color: #d1e7dd;
            border-left: 4px solid #198754;
            padding: 8px;
            border-radius: 4px;
        }

        .solution-card {
            background-color: #f0f8ff;
            border-left: 3px solid #0dcaf0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .explanation-text {
            border-top: 1px dashed #ced4da;
            padding-top: 10px;
            margin-top: 15px;
        }

        /* Style for LaTeX display mode */
        .katex-display {
            margin-top: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="container quiz-container">
        <h1 class="my-4 text-center text-primary">ðŸ§¬ Quiz Structure & Validation Review</h1>

        <div id="quiz-details-container" class="mb-5"></div>

        <!-- NEW: Generate Quiz Form -->
        <div class="card mb-5 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">âœ¨ Generate New Questions</h5>
            </div>
            <div class="card-body">
                <form id="generate-form" onsubmit="handleGenerateQuiz(event)">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Board</label>
                            <input type="text" class="form-control" name="board" value="CBSE" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Grade</label>
                            <input type="text" class="form-control" name="grade" value="10" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" name="subject" value="Science" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Chapter Name</label>
                            <input type="text" class="form-control" name="chapter_name"
                                placeholder="e.g. Life Processes" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Chapter ID</label>
                            <input type="number" class="form-control" name="chapter_id" placeholder="123" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Num Questions</label>
                            <input type="number" class="form-control" name="num_questions" value="3" min="1" max="10"
                                required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Additional Instructions</label>
                            <textarea class="form-control" name="additional_instructions" rows="2"
                                placeholder="e.g. Include questions with diagrams..."></textarea>
                        </div>
                        <div class="col-md-12 d-flex align-items-end justify-content-end">
                            <button type="submit" class="btn btn-success px-4" id="generate-btn">
                                <span class="spinner-border spinner-border-sm d-none" role="status"
                                    aria-hidden="true"></span>
                                <span class="btn-text">Generate Questions</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Filter Section -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-6">
                <h2 class="text-secondary mb-0">All Questions</h2>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">Filter ID</span>
                    <input type="number" id="filter-chapter-id" class="form-control" placeholder="Enter Chapter ID">
                    <button class="btn btn-outline-primary" type="button" onclick="filterQuestions()">Filter</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="clearFilter()">Clear</button>
                </div>
            </div>
        </div>
        <div id="questions-list"></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <script>
        // --- 1. API Configuration ---
        const API_BASE_URL = 'http://localhost:8000';  // Update this if your API runs on a different port

        // --- 2. Function to fetch quiz data from API ---
        async function fetchQuizData() {
            setLoading(true, false); // Show loading only for initial load, don't disable everything yet
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/quizzes`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching quiz data:', error);
                return null;
            } finally {
                setLoading(false);
            }
        }

        // --- Global Questions Store ---
        let allQuestions = [];

        // --- Loader & UI State Management ---
        function setLoading(isLoading, isGenerating = false) {
            const btn = document.getElementById('generate-btn');
            const spinner = btn.querySelector('.spinner-border');
            const btnText = btn.querySelector('.btn-text');
            const allButtons = document.querySelectorAll('button');

            if (isLoading) {
                // Disable all buttons
                allButtons.forEach(b => b.disabled = true);
                if (isGenerating) {
                    spinner.classList.remove('d-none');
                    btnText.textContent = 'Generating...';
                }
            } else {
                // Enable all buttons
                allButtons.forEach(b => b.disabled = false);
                spinner.classList.add('d-none');
                btnText.textContent = 'Generate Questions';
            }
        }

        // --- Generate Quiz Handler ---
        async function handleGenerateQuiz(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const payload = {
                board: formData.get('board'),
                grade: formData.get('grade'),
                subject: formData.get('subject'),
                chapter_name: formData.get('chapter_name'),
                chapter_id: parseInt(formData.get('chapter_id')),
                num_questions: parseInt(formData.get('num_questions')),
                additional_instructions: formData.get('additional_instructions') || "None",
                // defaults
                question_types: null,
                difficulty_distribution: null,
            };

            setLoading(true, true);

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/generate-quiz`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Generation failed: ${response.statusText}`);

                const result = await response.json();

                if (result.success) {
                    alert('Questions generated successfully! Refreshing list...');
                    // Reload questions
                    await loadAndRenderQuestions();
                    // Optionally clear form
                    // event.target.reset();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } catch (error) {
                console.error('Generation error:', error);
                alert(`Generation failed: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- Filter Logic ---
        function filterQuestions() {
            const chapterIdInput = document.getElementById('filter-chapter-id').value;
            if (!chapterIdInput) {
                alert('Please enter a Chapter ID');
                return;
            }

            const chapterId = parseInt(chapterIdInput);
            const filtered = allQuestions.filter(q => q.chapter_id === chapterId);

            renderQuestions(filtered);
            renderMetadata(filtered); // Update metadata to reflect filtered view
        }

        function clearFilter() {
            document.getElementById('filter-chapter-id').value = '';
            renderQuestions(allQuestions);
            renderMetadata(allQuestions);
        }

        async function loadAndRenderQuestions() {
            const data = await fetchQuizData();

            if (!data || !data.success) {
                document.getElementById('quiz-details-container').innerHTML =
                    '<div class="alert alert-danger">Failed to load quiz data from the database.</div>';
                document.getElementById('questions-list').innerHTML =
                    '<div class="alert alert-warning">Unable to fetch questions. Please ensure the backend API is running.</div>';
                return;
            }

            if (data.quizzes) {
                allQuestions = data.quizzes; // Store in global
                renderMetadata(allQuestions);
                renderQuestions(allQuestions);
            } else {
                allQuestions = [];
                document.getElementById('quiz-details-container').innerHTML = '';
                document.getElementById('questions-list').innerHTML =
                    '<div class="alert alert-info">No questions found in the database.</div>';
            }
        }

        // --- 3. Helper function to render content (handles text and image data) ---
        function renderContent(contentArray) {
            if (!contentArray) return '';
            let html = '';
            contentArray.forEach(item => {
                if (item.type === 'text') {
                    // Use marked.js to convert Markdown (which may contain LaTeX) to HTML
                    const markdownHtml = marked.parse(item.content);
                    html += `<div class="content-text">${markdownHtml}</div>`;
                } else if (item.type === 'image' && item.content) {
                    let imageHtml = '';
                    // Check if content is a raw SVG string
                    if (item.content.trim().startsWith('<svg')) {
                        imageHtml = `<div class="svg-container" style="max-width: 100%; overflow-x: auto;">${item.content}</div>`;
                    } else {
                        // Check if content is already a data URI or needs prefix
                        const src = item.content.startsWith('data:image') ? item.content : `data:image/png;base64,${item.content}`;
                        imageHtml = `<img src="${src}" class="img-preview rounded" alt="${item.image_desc || 'Question Image'}" style="max-width: 200px; border: 1px solid #ccc;">`;
                    }

                    html += `
                        <div class="mt-2 mb-3">
                            ${imageHtml}
                            <p class="text-muted small mt-1">Image Description: ${item.image_desc || 'N/A'}</p>
                        </div>
                    `;
                }
            });
            return html;
        }

        // --- 4. Function to render the questions ---
        function renderQuestions(questions) {
            const listContainer = document.getElementById('questions-list');
            listContainer.innerHTML = '';

            if (!questions || questions.length === 0) {
                listContainer.innerHTML = '<div class="alert alert-info">No questions found in the database.</div>';
                return;
            }

            questions.forEach((q, index) => {
                let optionsHtml = '';
                if (q.question_type === 'objective' && q.options && q.options.length > 0) {
                    optionsHtml = '<ul class="list-unstyled mt-3">';
                    q.options.forEach((opt, i) => {
                        const optionClass = opt.is_correct ? 'correct-option' : '';
                        optionsHtml += `
                            <li class="mb-2 ${optionClass}">
                                <strong>${String.fromCharCode(65 + i)}.</strong> 
                                <span class="option-content">${renderContent(opt.option)}</span>
                            </li>
                        `;
                    });
                    optionsHtml += '</ul>';
                }

                // Parse the explanation text for Markdown and LaTeX
                const explanationParsed = marked.parse(q.explanation || '');

                const solutionHtml = `
                    <div class="solution-card">
                        <h5 class="text-info">ðŸ’¡ Solution & Explanation</h5>
                        <div class="small">
                            <h6>Solution:</h6>
                            ${renderContent(q.solution)}
                        </div>
                        <div class="explanation-text small mt-3">
                            <h6>Detailed Explanation:</h6>
                            <div class="explanation-content">${explanationParsed}</div>
                        </div>
                    </div>
                `;

                const questionHtml = `
                    <div class="question-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h4 class="mb-0 text-dark">Q${index + 1}: ${renderContent(q.question)}</h4>
                            <div class="text-end">
                                <span class="badge bg-secondary me-2">${(q.question_type || 'unknown').toUpperCase()}</span>
                                <span class="badge bg-primary">${q.marks || 0} Marks (${q.difficulty || 'medium'})</span>
                            </div>
                        </div>
                        
                        ${optionsHtml}
                        
                        ${solutionHtml}
                    </div>
                `;
                listContainer.innerHTML += questionHtml;
            });

            // After all content is added to the DOM, run KaTeX auto-rendering
            renderMathInElement(listContainer, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false },
                ],
            });
        }

        // --- 5. Function to render quiz metadata ---
        function renderMetadata(questions) {
            const container = document.getElementById('quiz-details-container');

            const totalQuestions = questions.length;
            const totalMarks = questions.reduce((sum, q) => sum + (q.marks || 0), 0);

            // Since we receive a flat list of questions, we don't have global verification status or generation time.
            // We'll display the aggregate stats.

            container.innerHTML = `
                <div class="metadata-card border">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <h4 class="mb-3">Question Bank Summary</h4>
                            <div class="d-flex gap-4">
                                <p class="mb-0 fs-5"><strong>Total Questions:</strong> ${totalQuestions}</p>
                                <p class="mb-0 fs-5"><strong>Total Marks:</strong> ${totalMarks}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 6. Initial rendering call ---
        // --- 6. Initial rendering call ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAndRenderQuestions();
        });
    </script>
</body>

</html>